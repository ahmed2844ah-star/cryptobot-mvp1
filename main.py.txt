from fastapi import FastAPI, Request, Form, Depends
from fastapi.responses import HTMLResponse, RedirectResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
from sqlalchemy.orm import Session
from database import SessionLocal, engine, Base
from models import User
from passlib.hash import bcrypt
from analysis import analyze

Base.metadata.create_all(bind=engine)

app = FastAPI()
templates = Jinja2Templates(directory="templates")
app.mount("/static", StaticFiles(directory="static"), name="static")

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@app.get("/", response_class=HTMLResponse)
def home(request: Request):
    return templates.TemplateResponse("index.html", {"request": request})

@app.get("/register", response_class=HTMLResponse)
def register_get(request: Request):
    return templates.TemplateResponse("register.html", {"request": request})

@app.post("/register")
def register_post(email: str = Form(...), password: str = Form(...), db: Session = Depends(get_db)):
    hashed_password = bcrypt.hash(password)
    user = User(email=email, password=hashed_password, plan="free")
    db.add(user)
    db.commit()
    return RedirectResponse(url="/login", status_code=303)

@app.get("/login", response_class=HTMLResponse)
def login_get(request: Request):
    return templates.TemplateResponse("login.html", {"request": request})

@app.post("/login")
def login_post(email: str = Form(...), password: str = Form(...), db: Session = Depends(get_db)):
    user = db.query(User).filter(User.email == email).first()
    if not user or not bcrypt.verify(password, user.password):
        return HTMLResponse("بيانات غير صحيحة")
    response = RedirectResponse(url="/dashboard", status_code=303)
    response.set_cookie(key="user_email", value=user.email)
    return response

@app.get("/dashboard", response_class=HTMLResponse)
def dashboard(request: Request, db: Session = Depends(get_db)):
    user_email = request.cookies.get("user_email")
    if not user_email:
        return RedirectResponse(url="/login")
    user = db.query(User).filter(User.email == user_email).first()
    return templates.TemplateResponse("dashboard.html", {"request": request, "plan": user.plan})

@app.post("/analyze")
def analyze_post(symbol: str = Form(...), type_: str = Form(...), timeframe: str = Form(...), db: Session = Depends(get_db), request: Request = None):
    user_email = request.cookies.get("user_email")
    user = db.query(User).filter(User.email == user_email).first()
    if user.plan == "free" and (type_=="futures" or timeframe!="1h"):
        return {"error": "هذه الميزة متاحة لمشترك Pro فقط"}
    return analyze(symbol, type_, timeframe)
